#!/usr/bin/env bash
set -e
: ${GPG_KEY_FILE:?"A GPG symmetric key is required in order to unlock the encrypted resources."}
: ${1:?"Please provide a Make target to run."}

./scripts/docker/prepare.for.ci

git-crypt unlock $GPG_KEY_FILE
trap 'git-crypt lock --force' EXIT
source <(cat environments/${TARGET_ENV:-dev}.env | grep -E -v '^$|^#' | sed '/^export/!s/^/export /')

make $*
