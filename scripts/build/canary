#!/usr/bin/env bash
set -e

function success () {
  echo
  echo
  echo "       $1"
  echo '                     /               '
  echo '                .-"-.                '
  echo '               / 4 4 \               '
  echo '               \_ v _/               '
  echo '               //   \\               '
  echo '              ((     ))              '
  echo '        =======""===""=======        '
  echo '                 |||                 '
  echo "                 '|'                 "
  echo
  echo
  exit
}

echo "=> Updating node version to the latest stable..."
LATEST_NODE_VERSION=$(curl -Ls https://semver.io/node/stable)
perl -pi -e "s|\"node\": \".*\"|\"node\": \"${LATEST_NODE_VERSION}\"|" package.json

./scripts/docker/prepare.for.ci

echo "=> Updating package.json dependencies..."
npm install -g npm-check-updates
ncu --upgradeAll --packageFile package.json
npm update

echo "=> Updating bower.json dependencies..."
npm install -g http://github.com/sapegin/bower-update/tarball/master
bower-update -i

[[ $(git diff --shortstat 2> /dev/null | tail -n1) != "" ]] || success "There's nothing new. Success."

echo "=> Resetting npm-shrinkwrap.json..."
rm npm-shrinkwrap.json

echo "=> Running CI..."
make all

echo "=> Updating npm-shrinkwrap.json..."
npm shrinkwrap --dev

echo "=> Commiting updates to 'canary'..."
git -c user.name='Canary Build' -c user.email='email@example.com' commit  -a -u -m "[canary] Update dependencies."

success "All clear! We are all alive!"
